#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
GUI Avanzada para DescargasOrdenadas v3.0 con todas las funcionalidades
"""

import sys
import os
import logging
from pathlib import Path
from datetime import datetime

try:
    from PySide6.QtCore import Qt, Signal, Slot, QThread, QTimer, QEvent
    from PySide6.QtGui import QIcon, QAction, QPixmap, QPainter
    from PySide6.QtWidgets import (
        QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, 
        QPushButton, QLabel, QCheckBox, QListWidget, QProgressBar, 
        QMessageBox, QSystemTrayIcon, QTabWidget, QTextEdit, QSlider, 
        QGroupBox, QComboBox, QPlainTextEdit, QInputDialog, QMenu,
        QFileDialog
    )
except ImportError:
    print("‚ùå PySide6 no instalado. Ejecuta: pip install PySide6")
    sys.exit(1)

from .file_organizer import OrganizadorArchivos
from .autostart import GestorAutoarranque

logger = logging.getLogger('organizador.gui_avanzada')

class OrganizadorAvanzado(QMainWindow):
    """GUI completa con todas las funcionalidades avanzadas."""
    
    def __init__(self, directorio=None):
        super().__init__()
        
        # Inicializar organizador
        if directorio:
            self.organizador = OrganizadorArchivos(carpeta_descargas=str(directorio), usar_subcarpetas=True)
        else:
            self.organizador = OrganizadorArchivos(usar_subcarpetas=True)
        
        self.gestor_autoarranque = GestorAutoarranque()
        
        # Estado de la aplicaci√≥n
        self.en_bandeja = False
        self.cerrar_completamente = False
        self._sincronizando_controles = False
        
        # Configuraci√≥n ventana
        self.setWindowTitle("üçÑ DescargasOrdenadas v3.0 - Funcionalidades Completas")
        self.setMinimumSize(1000, 700)
        
        self._setup_ui()
        self._aplicar_estilos_modernos()
        self._setup_system_tray()
        self._inicializar_modulos()
        
        # Timer para organizaci√≥n autom√°tica
        self.timer_auto = QTimer()
        self.timer_auto.timeout.connect(self._organizar_automatico)
    
    def _aplicar_estilos_modernos(self):
        """Aplica estilos modernos con tema oscuro."""
        self.setStyleSheet("""
            QMainWindow { 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #2b2b2b, stop:1 #1e1e1e);
                color: #ffffff;
            }
            QTabWidget::pane {
                border: 2px solid #404040;
                background-color: #2d2d2d;
                border-radius: 8px;
                margin-top: 5px;
            }
            QTabBar::tab {
                padding: 12px 20px;
                margin-right: 3px;
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #404040, stop:1 #353535);
                border: 1px solid #555555;
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                font-weight: bold;
                color: #cccccc;
                font-size: 12px;
            }
            QTabBar::tab:selected {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #4CAF50, stop:1 #45a049);
                color: #ffffff;
                border-bottom: 2px solid #4CAF50;
            }
            QTabBar::tab:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #505050, stop:1 #454545);
                color: #ffffff;
            }
            QGroupBox {
                font-weight: bold;
                border: 2px solid #505050;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 15px;
                background-color: #2d2d2d;
                color: #ffffff;
                font-size: 13px;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 15px;
                padding: 0 8px 0 8px;
                color: #ffffff;
                background-color: #2d2d2d;
            }
            QCheckBox {
                spacing: 8px;
                font-weight: normal;
                color: #ffffff;
                font-size: 13px;
            }
            QCheckBox::indicator {
                width: 18px;
                height: 18px;
                border-radius: 9px;
                border: 2px solid #666666;
                background-color: #3d3d3d;
            }
            QCheckBox::indicator:checked {
                background-color: #4CAF50;
                border-color: #4CAF50;
            }
            QCheckBox::indicator:hover {
                border-color: #888888;
            }
            QLabel {
                color: #ffffff;
                font-size: 13px;
            }
            QListWidget {
                border: 1px solid #505050;
                border-radius: 6px;
                background-color: #3d3d3d;
                color: #ffffff;
                selection-background-color: #4CAF50;
                selection-color: #ffffff;
            }
            QTextEdit, QPlainTextEdit {
                border: 1px solid #505050;
                border-radius: 6px;
                background-color: #3d3d3d;
                color: #ffffff;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 12px;
            }
            QSlider::groove:horizontal {
                border: 1px solid #505050;
                height: 6px;
                background: #3d3d3d;
                border-radius: 3px;
            }
            QSlider::handle:horizontal {
                background: #4CAF50;
                border: 1px solid #45a049;
                width: 18px;
                border-radius: 9px;
                margin: -6px 0;
            }
            QSlider::handle:horizontal:hover {
                background: #66BB6A;
            }
            QPushButton {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #4CAF50, stop:1 #45a049);
                color: white;
                border: none;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: bold;
                font-size: 13px;
                min-height: 16px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #66BB6A, stop:1 #4CAF50);
                transform: translateY(-1px);
            }
            QPushButton:pressed {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #3d8b40, stop:1 #2e7d32);
            }
            QPushButton:disabled {
                background-color: #555555;
                color: #999999;
            }
            QComboBox {
                border: 1px solid #505050;
                border-radius: 6px;
                padding: 8px 12px;
                background-color: #3d3d3d;
                color: #ffffff;
                font-size: 13px;
                min-height: 20px;
            }
            QComboBox:hover {
                border-color: #4CAF50;
            }
            QComboBox::drop-down {
                border: none;
                width: 30px;
            }
            QComboBox::down-arrow {
                image: none;
                border-left: 6px solid transparent;
                border-right: 6px solid transparent;
                border-top: 8px solid #ffffff;
                margin-right: 8px;
            }
            QComboBox QAbstractItemView {
                border: 1px solid #505050;
                background-color: #3d3d3d;
                color: #ffffff;
                selection-background-color: #4CAF50;
            }
            QProgressBar {
                border: 1px solid #505050;
                border-radius: 6px;
                text-align: center;
                font-weight: bold;
                background-color: #3d3d3d;
                color: #ffffff;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0, 
                    stop:0 #4CAF50, stop:1 #66BB6A);
                border-radius: 5px;
            }
        """)
    
    def _setup_system_tray(self):
        """Configura bandeja del sistema completa."""
        if not QSystemTrayIcon.isSystemTrayAvailable():
            self._agregar_log("‚ùå Bandeja del sistema no disponible en este sistema")
            return
        
        # Crear icono para la bandeja
        self.tray_icon = QSystemTrayIcon(self)
        
        # Crear icono personalizado si no existe uno
        icon = self._crear_icono_personalizado()
        self.tray_icon.setIcon(icon)
        
        # Crear men√∫ contextual
        tray_menu = QMenu()
        
        # Acciones del men√∫
        mostrar_action = QAction("üìÇ Mostrar Ventana", self)
        mostrar_action.triggered.connect(self._mostrar_ventana)
        tray_menu.addAction(mostrar_action)
        
        organizar_action = QAction("üîÑ Organizar Ahora", self)
        organizar_action.triggered.connect(self._organizar)
        tray_menu.addAction(organizar_action)
        
        tray_menu.addSeparator()
        
        # Toggle auto-organizaci√≥n
        self.auto_action = QAction("‚ö° Auto-Organizaci√≥n", self)
        self.auto_action.setCheckable(True)
        self.auto_action.triggered.connect(self._toggle_auto_organizacion)
        tray_menu.addAction(self.auto_action)
        
        tray_menu.addSeparator()
        
        # Informaci√≥n
        info_action = QAction(f"üìÅ {os.path.basename(self.organizador.carpeta_descargas)}", self)
        info_action.setEnabled(False)
        tray_menu.addAction(info_action)
        
        tray_menu.addSeparator()
        
        salir_action = QAction("‚ùå Salir", self)
        salir_action.triggered.connect(self._salir_completamente)
        tray_menu.addAction(salir_action)
        
        # Asignar men√∫ al icono
        self.tray_icon.setContextMenu(tray_menu)
        
        # Conectar eventos
        self.tray_icon.activated.connect(self._tray_icon_activated)
        
        # Mostrar tooltip
        self.tray_icon.setToolTip("üçÑ DescargasOrdenadas v3.0 - Organizador Activo")
        
        # Mostrar icono
        self.tray_icon.show()
        
        self._agregar_log("‚úÖ Bandeja del sistema configurada")
    
    def _inicializar_modulos(self):
        """Inicializa m√≥dulos avanzados."""
        funciones = []
        carpeta = Path(self.organizador.carpeta_descargas)
        
        # IA
        try:
            from .ai_categorizer import CategorizadorIA
            self.ai_categorizer = CategorizadorIA(carpeta)
            funciones.append("ü§ñ IA")
            if hasattr(self, 'lbl_ia_estado'):
                self.lbl_ia_estado.setText("‚úÖ IA Categorizaci√≥n: Activa")
        except Exception as e:
            self.ai_categorizer = None
            if hasattr(self, 'lbl_ia_estado'):
                self.lbl_ia_estado.setText("‚ùå IA: No disponible")
            self._agregar_log(f"‚ö†Ô∏è IA no disponible: {e}")
        
        # Fechas
        try:
            from .date_organizer import OrganizadorPorFecha
            self.date_organizer = OrganizadorPorFecha(carpeta)
            funciones.append("üìÖ Fechas")
            
            # Verificar si fechas est√° activa
            try:
                config_fechas = self.date_organizer.configuracion
                if config_fechas.get('activo', False) and hasattr(self, 'lbl_estado_fechas'):
                    self.lbl_estado_fechas.setText("‚úÖ Organizaci√≥n por fechas: ACTIVADA")
                    self.lbl_estado_fechas.setStyleSheet("""
                        font-weight: bold; 
                        padding: 10px; 
                        color: #ffffff;
                        background-color: #4CAF50;
                        border-radius: 6px;
                        font-size: 14px;
                    """)
                    if hasattr(self, 'btn_activar_fechas'):
                        self.btn_activar_fechas.setEnabled(False)
                    if hasattr(self, 'btn_desactivar_fechas'):
                        self.btn_desactivar_fechas.setEnabled(True)
            except:
                pass  # Si hay error leyendo config, mantener estado por defecto
        except Exception as e:
            self.date_organizer = None
            self._agregar_log(f"‚ö†Ô∏è Fechas no disponible: {e}")
        
        # Duplicados
        try:
            from .duplicate_detector import DetectorDuplicados
            self.duplicate_detector = DetectorDuplicados(carpeta)
            funciones.append("üîç Duplicados")
        except Exception as e:
            self.duplicate_detector = None
            self._agregar_log(f"‚ö†Ô∏è Duplicados no disponible: {e}")
        
        # Estad√≠sticas
        try:
            from .statistics import EstadisticasOrganizador
            self.stats_manager = EstadisticasOrganizador(carpeta)
            funciones.append("üìä Stats")
        except Exception as e:
            self.stats_manager = None
            self._agregar_log(f"‚ö†Ô∏è Estad√≠sticas no disponible: {e}")
        
        # Reglas
        try:
            from .custom_rules import GestorReglasPersonalizadas
            self.custom_rules = GestorReglasPersonalizadas(carpeta)
            funciones.append("‚öôÔ∏è Reglas")
        except Exception as e:
            self.custom_rules = None
            self._agregar_log(f"‚ö†Ô∏è Reglas personalizadas no disponible: {e}")
        
        # Actualizar estado
        if hasattr(self, 'lbl_estado'):
            if funciones:
                self.lbl_estado.setText("‚úÖ " + " | ".join(funciones))
            else:
                self.lbl_estado.setText("‚ùå Solo funcionalidades b√°sicas")
        
        self._actualizar_datos()
    
    def _actualizar_datos(self):
        """Actualiza datos de las pesta√±as."""
        if hasattr(self, 'ai_categorizer') and self.ai_categorizer:
            self._actualizar_patrones()
        
        if hasattr(self, 'stats_manager') and self.stats_manager:
            self._actualizar_estadisticas()
    
    def _crear_icono_personalizado(self):
        """Crea un icono personalizado para la bandeja."""
        try:
            # Crear un pixmap de 64x64
            pixmap = QPixmap(64, 64)
            pixmap.fill(Qt.transparent)
            
            painter = QPainter(pixmap)
            painter.setRenderHint(QPainter.Antialiasing)
            
            # Dibujar fondo circular
            painter.setBrush(Qt.green)
            painter.setPen(Qt.NoPen)
            painter.drawEllipse(4, 4, 56, 56)
            
            # Dibujar s√≠mbolo de carpeta
            painter.setPen(Qt.white)
            painter.setFont(painter.font())
            painter.drawText(pixmap.rect(), Qt.AlignCenter, "üìÅ")
            
            painter.end()
            
            return QIcon(pixmap)
        except:
            # Fallback a icono por defecto
            return self.style().standardIcon(self.style().SP_DirIcon)
    
    def _tray_icon_activated(self, reason):
        """Maneja la activaci√≥n del icono de la bandeja."""
        if reason == QSystemTrayIcon.Trigger:  # Click simple
            self._mostrar_ocultar_ventana()
        elif reason == QSystemTrayIcon.DoubleClick:  # Doble click
            self._mostrar_ventana()
    
    def _mostrar_ocultar_ventana(self):
        """Alterna entre mostrar y ocultar la ventana."""
        if self.isVisible():
            self._ocultar_en_bandeja()
        else:
            self._mostrar_ventana()
    
    def _mostrar_ventana(self):
        """Muestra la ventana desde la bandeja."""
        self.show()
        self.raise_()
        self.activateWindow()
        self.en_bandeja = False
        
        # Mostrar consola si estaba oculta
        self._mostrar_consola()
        
        self._agregar_log("üìÇ Ventana restaurada desde bandeja del sistema")
    
    def _ocultar_en_bandeja(self):
        """Oculta la ventana en la bandeja del sistema."""
        if self.tray_icon and self.tray_icon.isVisible():
            self.hide()
            self.en_bandeja = True
            
            # Ocultar consola
            self._ocultar_consola()
            
            # Mostrar notificaci√≥n
            self.tray_icon.showMessage(
                "üçÑ DescargasOrdenadas",
                "Aplicaci√≥n minimizada a la bandeja del sistema",
                QSystemTrayIcon.Information,
                3000
            )
            
            self._agregar_log("üì± Aplicaci√≥n minimizada a bandeja del sistema")
        else:
            # Si no hay bandeja disponible, solo minimizar
            self.showMinimized()
    
    def _salir_completamente(self):
        """Cierra la aplicaci√≥n completamente."""
        self._agregar_log("üö™ Cerrando aplicaci√≥n completamente...")
        
        # Detener timer si est√° activo
        if hasattr(self, 'timer_auto') and self.timer_auto.isActive():
            self.timer_auto.stop()
        
        # Cerrar la consola completamente
        self._cerrar_consola()
        
        self.cerrar_completamente = True
        QApplication.quit()
    
    def _toggle_auto_organizacion(self, activo):
        """Activa/desactiva la organizaci√≥n autom√°tica."""
        # Prevenir recursi√≥n durante sincronizaci√≥n
        if self._sincronizando_controles:
            return
            
        if activo:
            # Iniciar timer cada 30 segundos
            self.timer_auto.start(30000)
            if hasattr(self, 'tray_icon') and self.tray_icon:
                self.tray_icon.setToolTip("üçÑ DescargasOrdenadas v3.0 - Auto-Organizaci√≥n ACTIVA")
            self._agregar_log("‚ö° Auto-organizaci√≥n activada (cada 30 segundos)")
            
            # Sincronizar controles sin recursi√≥n
            self._sincronizando_controles = True
            if hasattr(self, 'auto_action'):
                self.auto_action.setChecked(True)
            if hasattr(self, 'chk_auto_organizacion'):
                self.chk_auto_organizacion.setChecked(True)
            self._sincronizando_controles = False
            
            # Notificaci√≥n √∫nica al activar (no molesta)
            if hasattr(self, 'tray_icon') and self.tray_icon:
                self.tray_icon.showMessage(
                    "‚ö° Auto-Organizaci√≥n Activada",
                    "Funcionando silenciosamente en segundo plano cada 30s",
                    QSystemTrayIcon.Information,
                    2000
                )
        else:
            self.timer_auto.stop()
            if hasattr(self, 'tray_icon') and self.tray_icon:
                self.tray_icon.setToolTip("üçÑ DescargasOrdenadas v3.0 - Organizador Activo")
            self._agregar_log("‚èπÔ∏è Auto-organizaci√≥n desactivada")
            
            # Sincronizar controles sin recursi√≥n
            self._sincronizando_controles = True
            if hasattr(self, 'auto_action'):
                self.auto_action.setChecked(False)
            if hasattr(self, 'chk_auto_organizacion'):
                self.chk_auto_organizacion.setChecked(False)
            self._sincronizando_controles = False
    
    def _organizar_automatico(self):
        """Organiza archivos autom√°ticamente en segundo plano."""
        try:
            import datetime
            hora_actual = datetime.datetime.now().strftime("%H:%M:%S")
            
            # DEBUG: Mostrar que el timer est√° funcionando
            if hasattr(self, '_debug_timer_count'):
                self._debug_timer_count += 1
            else:
                self._debug_timer_count = 1
            
            # Organizar solo archivos nuevos de forma silenciosa
            resultados, errores = self.organizador.organizar()
            total = sum(len(files) for cat in resultados.values() for files in cat.values())
            
            # Log de actividad (con o sin archivos)
            if total > 0:
                self._agregar_log(f"‚ö° Auto-organizaci√≥n {hora_actual}: {total} archivos organizados")
                
                # Actualizar tooltip de la bandeja para mostrar √∫ltima actividad
                if self.tray_icon:
                    self.tray_icon.setToolTip(f"üçÑ DescargasOrdenadas - √öltima org: {hora_actual} ({total} archivos)")
                    
                # Actualizar estad√≠sticas si hay cambios
                self._actualizar_datos()
            else:
                # Log cada 5 ejecuciones para confirmar que funciona
                if self._debug_timer_count % 5 == 0:
                    self._agregar_log(f"üîç Timer activo {hora_actual}: revisando archivos... (#{self._debug_timer_count})")
                
                # Actualizar tooltip para mostrar que est√° funcionando
                if self.tray_icon:
                    self.tray_icon.setToolTip(f"üçÑ DescargasOrdenadas - Revisando: {hora_actual} (Activo)")
                
        except Exception as e:
            self._agregar_log(f"‚ùå Error en auto-organizaci√≥n: {e}")
    
    def _ocultar_consola(self):
        """Oculta la consola del sistema."""
        try:
            if sys.platform == "win32":
                import ctypes
                console_window = ctypes.windll.kernel32.GetConsoleWindow()
                if console_window:
                    ctypes.windll.user32.ShowWindow(console_window, 0)  # SW_HIDE
            # En Linux/Mac la consola se maneja diferente, normalmente no es necesario ocultarla
        except Exception as e:
            logger.debug(f"No se pudo ocultar consola: {e}")
    
    def _mostrar_consola(self):
        """Muestra la consola del sistema."""
        try:
            if sys.platform == "win32":
                import ctypes
                console_window = ctypes.windll.kernel32.GetConsoleWindow()
                if console_window:
                    ctypes.windll.user32.ShowWindow(console_window, 5)  # SW_SHOW
        except Exception as e:
            logger.debug(f"No se pudo mostrar consola: {e}")
    
    def _cerrar_consola(self):
        """Cierra la ventana de consola del sistema."""
        try:
            if sys.platform == "win32":
                import ctypes
                console_window = ctypes.windll.kernel32.GetConsoleWindow()
                if console_window:
                    # Cerrar la ventana de consola
                    ctypes.windll.user32.PostMessageW(console_window, 0x0010, 0, 0)  # WM_CLOSE
        except Exception as e:
            logger.debug(f"No se pudo cerrar consola: {e}")
    
    def changeEvent(self, event):
        """Maneja eventos de cambio de estado de la ventana."""
        if event.type() == QEvent.Type.WindowStateChange:
            if self.isMinimized():
                # Si se minimiza, ir a la bandeja
                self._ocultar_en_bandeja()
                event.ignore()
                return
        
        super().changeEvent(event)
    
    def closeEvent(self, event):
        """Maneja el evento de cierre de la ventana."""
        if self.cerrar_completamente:
            # Cierre definitivo
            if hasattr(self, 'tray_icon'):
                self.tray_icon.hide()
            # Cerrar consola al salir completamente
            self._cerrar_consola()
            event.accept()
        else:
            # Minimizar a bandeja en lugar de cerrar
            if hasattr(self, 'tray_icon') and self.tray_icon.isVisible():
                self._ocultar_en_bandeja()
                event.ignore()
            else:
                # Si no hay bandeja, preguntar al usuario
                reply = QMessageBox.question(
                    self, 
                    "Cerrar Aplicaci√≥n",
                    "¬øDeseas cerrar completamente la aplicaci√≥n?\n\n"
                    "‚Ä¢ S√≠: Cerrar completamente\n"
                    "‚Ä¢ No: Minimizar a barra de tareas",
                    QMessageBox.Yes | QMessageBox.No,
                    QMessageBox.No
                )
                
                if reply == QMessageBox.Yes:
                    self.cerrar_completamente = True
                    self._cerrar_consola()
                    event.accept()
                else:
                    self.showMinimized()
                    event.ignore()

    def _setup_ui(self):
        """Configura la interfaz principal."""
        central_widget = QWidget()
        self.setCentralWidget(central_widget)
        layout = QVBoxLayout(central_widget)
        
        # Header
        self.header = QLabel(f"üçÑ DescargasOrdenadas v3.0 | üìÅ {self.organizador.carpeta_descargas}")
        self.header.setStyleSheet("""
            font-weight: bold; 
            font-size: 14px; 
            padding: 15px; 
            background: qlineargradient(x1:0, y1:0, x2:1, y2:0, 
                stop:0 #4a90e2, stop:1 #67b26f);
            color: white;
            border-radius: 8px;
            margin-bottom: 5px;
        """)
        layout.addWidget(self.header)
        
        # Pesta√±as
        self.tabs = QTabWidget()
        layout.addWidget(self.tabs)
        
        self._crear_tab_principal()
        self._crear_tab_ia()
        self._crear_tab_fechas()
        self._crear_tab_duplicados()
        self._crear_tab_estadisticas()
        self._crear_tab_logs()
        
        # Barra de progreso
        self.progress_bar = QProgressBar()
        self.progress_bar.setVisible(False)
        layout.addWidget(self.progress_bar)
        
        self.statusBar().showMessage("üçÑ Listo - Todas las funcionalidades cargadas")
    
    def _crear_tab_principal(self):
        """Pesta√±a principal de organizaci√≥n."""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # Botones principales
        botones_group = QGroupBox("üöÄ Organizaci√≥n")
        botones_layout = QHBoxLayout(botones_group)
        
        btn_organizar = QPushButton("üöÄ Organizar Nuevos")
        btn_organizar.setStyleSheet("""
            QPushButton {
                padding: 12px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #4CAF50, stop:1 #45a049);
                color: white; 
                font-size: 14px; 
                font-weight: bold;
                border-radius: 6px;
                border: none;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #45a049, stop:1 #3d8b40);
            }
            QPushButton:pressed {
                background: #3d8b40;
            }
        """)
        btn_organizar.clicked.connect(self._organizar)
        botones_layout.addWidget(btn_organizar)
        
        btn_reorganizar = QPushButton("üîÑ Reorganizar TODO")
        btn_reorganizar.setStyleSheet("""
            QPushButton {
                padding: 12px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #FF9800, stop:1 #f57c00);
                color: white; 
                font-size: 14px; 
                font-weight: bold;
                border-radius: 6px;
                border: none;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #f57c00, stop:1 #ef6c00);
            }
            QPushButton:pressed {
                background: #ef6c00;
            }
        """)
        btn_reorganizar.clicked.connect(self._reorganizar)
        botones_layout.addWidget(btn_reorganizar)
        
        layout.addWidget(botones_group)
        
        # Configuraciones
        config_group = QGroupBox("‚öôÔ∏è Configuraci√≥n")
        config_layout = QVBoxLayout(config_group)
        
        # Selecci√≥n de carpeta
        carpeta_layout = QHBoxLayout()
        self.lbl_carpeta_actual = QLabel(f"üìÅ Carpeta actual: {os.path.basename(self.organizador.carpeta_descargas)}")
        self.lbl_carpeta_actual.setStyleSheet("font-weight: bold; color: #4CAF50;")
        carpeta_layout.addWidget(self.lbl_carpeta_actual)
        
        btn_seleccionar_carpeta = QPushButton("üìÇ Cambiar Carpeta")
        btn_seleccionar_carpeta.setStyleSheet("""
            QPushButton {
                padding: 8px 16px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #2196F3, stop:1 #1976D2);
                color: white; 
                font-size: 12px; 
                font-weight: bold;
                border-radius: 5px;
                border: none;
                max-width: 150px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #1976D2, stop:1 #1565C0);
            }
            QPushButton:pressed {
                background: #1565C0;
            }
        """)
        btn_seleccionar_carpeta.clicked.connect(self._seleccionar_carpeta)
        carpeta_layout.addWidget(btn_seleccionar_carpeta)
        
        btn_reset_carpeta = QPushButton("‚Üª Descargas")
        btn_reset_carpeta.setStyleSheet("""
            QPushButton {
                padding: 8px 12px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #757575, stop:1 #616161);
                color: white; 
                font-size: 12px; 
                font-weight: bold;
                border-radius: 5px;
                border: none;
                max-width: 100px;
            }
            QPushButton:hover {
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #616161, stop:1 #424242);
            }
            QPushButton:pressed {
                background: #424242;
            }
        """)
        btn_reset_carpeta.setToolTip("Volver a la carpeta de descargas predeterminada")
        btn_reset_carpeta.clicked.connect(self._reset_carpeta_descargas)
        carpeta_layout.addWidget(btn_reset_carpeta)
        
        config_layout.addLayout(carpeta_layout)
        
        self.chk_autoarranque = QCheckBox("üîÑ Iniciar con el sistema")
        self.chk_autoarranque.toggled.connect(self._toggle_autoarranque)
        config_layout.addWidget(self.chk_autoarranque)
        
        self.chk_auto_organizacion = QCheckBox("‚ö° Auto-organizaci√≥n cada 30 segundos")
        self.chk_auto_organizacion.setToolTip("Organiza autom√°ticamente archivos nuevos cada 30 segundos")
        self.chk_auto_organizacion.toggled.connect(self._toggle_auto_organizacion)
        config_layout.addWidget(self.chk_auto_organizacion)
        
        self.chk_subcarpetas = QCheckBox("üìÅ Usar subcarpetas detalladas")
        self.chk_subcarpetas.setChecked(True)
        config_layout.addWidget(self.chk_subcarpetas)
        
        self.chk_recursivo = QCheckBox("üîç Buscar en subcarpetas")
        config_layout.addWidget(self.chk_recursivo)
        
        layout.addWidget(config_group)
        
        # Estado de funcionalidades
        estado_group = QGroupBox("‚ö° Funcionalidades Avanzadas")
        estado_layout = QVBoxLayout(estado_group)
        
        self.lbl_estado = QLabel("üîÑ Cargando funcionalidades...")
        estado_layout.addWidget(self.lbl_estado)
        
        layout.addWidget(estado_group)
        
        # Lista de archivos
        self.list_archivos = QListWidget()
        layout.addWidget(self.list_archivos)
        
        self.tabs.addTab(tab, "üè† Principal")
    
    def _crear_tab_ia(self):
        """Pesta√±a de IA."""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # Control IA
        ia_group = QGroupBox("ü§ñ Categorizaci√≥n Inteligente con IA")
        ia_layout = QVBoxLayout(ia_group)
        
        self.lbl_ia_estado = QLabel("üîÑ Verificando IA...")
        ia_layout.addWidget(self.lbl_ia_estado)
        
        # Confianza
        confianza_layout = QHBoxLayout()
        confianza_layout.addWidget(QLabel("Nivel de confianza:"))
        
        self.slider_confianza = QSlider(Qt.Horizontal)
        self.slider_confianza.setRange(30, 95)
        self.slider_confianza.setValue(60)
        self.slider_confianza.valueChanged.connect(self._actualizar_confianza)
        confianza_layout.addWidget(self.slider_confianza)
        
        self.lbl_confianza = QLabel("60%")
        confianza_layout.addWidget(self.lbl_confianza)
        
        ia_layout.addLayout(confianza_layout)
        
        # Botones IA
        botones_ia = QHBoxLayout()
        
        btn_entrenar = QPushButton("üß† Entrenar IA")
        btn_entrenar.clicked.connect(self._entrenar_ia)
        botones_ia.addWidget(btn_entrenar)
        
        btn_reset = QPushButton("üîÑ Reiniciar")
        btn_reset.clicked.connect(self._reset_ia)
        botones_ia.addWidget(btn_reset)
        
        ia_layout.addLayout(botones_ia)
        layout.addWidget(ia_group)
        
        # Patrones
        self.text_patrones = QTextEdit()
        self.text_patrones.setMaximumHeight(300)
        self.text_patrones.setReadOnly(True)
        layout.addWidget(self.text_patrones)
        
        self.tabs.addTab(tab, "ü§ñ IA")
    
    def _crear_tab_fechas(self):
        """Pesta√±a de organizaci√≥n por fechas."""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # Control fechas
        fechas_group = QGroupBox("üìÖ Organizaci√≥n por Fechas")
        fechas_layout = QVBoxLayout(fechas_group)
        
        # Estado actual
        self.lbl_estado_fechas = QLabel("‚ùå Organizaci√≥n por fechas: DESACTIVADA")
        self.lbl_estado_fechas.setStyleSheet("""
            font-weight: bold; 
            padding: 10px; 
            color: #ffffff;
            background-color: #f44336;
            border-radius: 6px;
            font-size: 14px;
        """)
        fechas_layout.addWidget(self.lbl_estado_fechas)
        
        # Botones de control
        botones_fechas_layout = QHBoxLayout()
        
        self.btn_activar_fechas = QPushButton("‚úÖ ACTIVAR Organizaci√≥n por Fechas")
        self.btn_activar_fechas.setStyleSheet("""
            QPushButton {
                padding: 10px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #2196F3, stop:1 #1976D2);
                color: white; 
                font-size: 12px; 
                font-weight: bold;
                border-radius: 5px;
                border: none;
            }
            QPushButton:hover { background: #1976D2; }
        """)
        self.btn_activar_fechas.clicked.connect(self._activar_fechas)
        botones_fechas_layout.addWidget(self.btn_activar_fechas)
        
        self.btn_desactivar_fechas = QPushButton("‚ùå DESACTIVAR Organizaci√≥n por Fechas")
        self.btn_desactivar_fechas.setStyleSheet("""
            QPushButton {
                padding: 10px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #f44336, stop:1 #d32f2f);
                color: white; 
                font-size: 12px; 
                font-weight: bold;
                border-radius: 5px;
                border: none;
            }
            QPushButton:hover { background: #d32f2f; }
        """)
        self.btn_desactivar_fechas.clicked.connect(self._desactivar_fechas)
        self.btn_desactivar_fechas.setEnabled(False)
        botones_fechas_layout.addWidget(self.btn_desactivar_fechas)
        
        fechas_layout.addLayout(botones_fechas_layout)
        
        # Patr√≥n
        patron_layout = QHBoxLayout()
        patron_layout.addWidget(QLabel("Patr√≥n:"))
        
        self.combo_patron = QComboBox()
        self.combo_patron.addItems([
            "YYYY/MM-Mes",
            "YYYY/MM", 
            "YYYY",
            "MM-YYYY",
            "Mes-YYYY"
        ])
        patron_layout.addWidget(self.combo_patron)
        
        fechas_layout.addLayout(patron_layout)
        
        # Ejemplo
        self.lbl_ejemplo = QLabel("üìÅ Ejemplo: Downloads/Fechas/2024/12-Diciembre/Documentos/")
        self.lbl_ejemplo.setStyleSheet("padding: 8px; background-color: #f5f5f5; border-radius: 4px; font-family: monospace;")
        fechas_layout.addWidget(self.lbl_ejemplo)
        
        # Revertir
        btn_revertir = QPushButton("‚Ü©Ô∏è Revertir Organizaci√≥n por Fechas")
        btn_revertir.setStyleSheet("""
            QPushButton {
                padding: 8px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #9C27B0, stop:1 #7B1FA2);
                color: white; 
                font-size: 11px; 
                font-weight: bold;
                border-radius: 4px;
                border: none;
            }
            QPushButton:hover { background: #7B1FA2; }
        """)
        btn_revertir.clicked.connect(self._revertir_fechas)
        fechas_layout.addWidget(btn_revertir)
        
        layout.addWidget(fechas_group)
        
        self.tabs.addTab(tab, "üìÖ Fechas")
    
    def _crear_tab_duplicados(self):
        """Pesta√±a de duplicados."""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # Controles
        dup_group = QGroupBox("üîç Detector de Duplicados")
        dup_layout = QVBoxLayout(dup_group)
        
        botones = QHBoxLayout()
        
        btn_buscar = QPushButton("üîç Buscar Duplicados")
        btn_buscar.clicked.connect(self._buscar_duplicados)
        botones.addWidget(btn_buscar)
        
        btn_eliminar = QPushButton("üóëÔ∏è Eliminar Duplicados")
        btn_eliminar.clicked.connect(self._eliminar_duplicados)
        botones.addWidget(btn_eliminar)
        
        dup_layout.addLayout(botones)
        layout.addWidget(dup_group)
        
        # Resultados
        self.text_duplicados = QPlainTextEdit()
        self.text_duplicados.setPlaceholderText("Los duplicados aparecer√°n aqu√≠...")
        layout.addWidget(self.text_duplicados)
        
        self.tabs.addTab(tab, "üîç Duplicados")
    
    def _crear_tab_estadisticas(self):
        """Pesta√±a de estad√≠sticas."""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # Control
        btn_actualizar = QPushButton("üîÑ Actualizar Estad√≠sticas")
        btn_actualizar.clicked.connect(self._actualizar_estadisticas)
        layout.addWidget(btn_actualizar)
        
        # Estad√≠sticas
        self.text_stats = QPlainTextEdit()
        self.text_stats.setReadOnly(True)
        layout.addWidget(self.text_stats)
        
        self.tabs.addTab(tab, "üìä Stats")
    
    def _crear_tab_logs(self):
        """Pesta√±a de logs y consola interna."""
        tab = QWidget()
        layout = QVBoxLayout(tab)
        
        # Controles
        controles_layout = QHBoxLayout()
        
        btn_limpiar = QPushButton("üóëÔ∏è Limpiar Logs")
        btn_limpiar.setStyleSheet("""
            QPushButton {
                padding: 8px 15px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #6c757d, stop:1 #5a6268);
                color: white; 
                font-size: 11px; 
                font-weight: bold;
                border-radius: 4px;
                border: none;
            }
            QPushButton:hover { background: #5a6268; }
        """)
        btn_limpiar.clicked.connect(self._limpiar_logs)
        controles_layout.addWidget(btn_limpiar)
        
        btn_exportar = QPushButton("üíæ Exportar Logs")
        btn_exportar.setStyleSheet("""
            QPushButton {
                padding: 8px 15px; 
                background: qlineargradient(x1:0, y1:0, x2:0, y2:1, 
                    stop:0 #17a2b8, stop:1 #138496);
                color: white; 
                font-size: 11px; 
                font-weight: bold;
                border-radius: 4px;
                border: none;
            }
            QPushButton:hover { background: #138496; }
        """)
        btn_exportar.clicked.connect(self._exportar_logs)
        controles_layout.addWidget(btn_exportar)
        
        controles_layout.addStretch()
        
        # Checkbox para mostrar/ocultar consola externa
        self.chk_mostrar_consola = QCheckBox("üñ•Ô∏è Mostrar consola externa")
        self.chk_mostrar_consola.setChecked(False)
        self.chk_mostrar_consola.toggled.connect(self._toggle_consola_externa)
        controles_layout.addWidget(self.chk_mostrar_consola)
        
        layout.addLayout(controles_layout)
        
        # √Årea de logs
        self.text_logs = QPlainTextEdit()
        self.text_logs.setReadOnly(True)
        self.text_logs.setStyleSheet("""
            QPlainTextEdit {
                background-color: #1e1e1e;
                color: #d4d4d4;
                font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
                font-size: 11px;
                border: 1px solid #454545;
                border-radius: 6px;
                padding: 5px;
            }
        """)
        self.text_logs.setPlainText("üçÑ DescargasOrdenadas v3.0 - Sistema de Logs Interno\n" + "="*60 + "\n")
        layout.addWidget(self.text_logs)
        
        self.tabs.addTab(tab, "üìã Logs")
        
        # Configurar captura de logs
        self._setup_log_capture()
    
    def _setup_log_capture(self):
        """Configura la captura de logs en la pesta√±a interna."""
        import logging
        
        # Handler personalizado para capturar logs
        class GuiLogHandler(logging.Handler):
            def __init__(self, text_widget):
                super().__init__()
                self.text_widget = text_widget
                
            def emit(self, record):
                try:
                    msg = self.format(record)
                    # Agregar timestamp y formatear
                    from datetime import datetime
                    timestamp = datetime.now().strftime("%H:%M:%S")
                    level_color = {
                        'INFO': 'üü¢',
                        'WARNING': 'üü°', 
                        'ERROR': 'üî¥',
                        'DEBUG': 'üîµ'
                    }.get(record.levelname, '‚ö™')
                    
                    formatted_msg = f"[{timestamp}] {level_color} {msg}"
                    
                    # Agregar al widget directamente
                    try:
                        self.text_widget.appendPlainText(formatted_msg)
                        scrollbar = self.text_widget.verticalScrollBar()
                        scrollbar.setValue(scrollbar.maximum())
                    except:
                        pass
                except:
                    pass
        
        # Crear handler
        self.log_handler = GuiLogHandler(self.text_logs)
        self.log_handler.setFormatter(
            logging.Formatter('%(name)s - %(levelname)s - %(message)s')
        )
        
        # Agregar a loggers principales
        logging.getLogger('DescargasOrdenadas').addHandler(self.log_handler)
        logging.getLogger('organizador').addHandler(self.log_handler)
        logging.getLogger('organizer').addHandler(self.log_handler)
    
    def _limpiar_logs(self):
        """Limpia el √°rea de logs."""
        self.text_logs.clear()
        self.text_logs.setPlainText("üçÑ DescargasOrdenadas v3.0 - Sistema de Logs Interno\n" + "="*60 + "\n")
    
    def _exportar_logs(self):
        """Exporta los logs a un archivo."""
        try:
            from datetime import datetime
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"descargasordenadas_logs_{timestamp}.txt"
            
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(self.text_logs.toPlainText())
            
            QMessageBox.information(self, "Logs Exportados", 
                                  f"‚úÖ Logs exportados a: {filename}")
        except Exception as e:
            QMessageBox.warning(self, "Error", f"‚ùå Error exportando logs: {e}")
    
    def _toggle_consola_externa(self, mostrar):
        """Muestra u oculta la consola externa."""
        try:
            import ctypes
            from ctypes import wintypes
            
            # Obtener handle de la consola
            kernel32 = ctypes.windll.kernel32
            user32 = ctypes.windll.user32
            
            console_window = kernel32.GetConsoleWindow()
            if console_window:
                if mostrar:
                    user32.ShowWindow(console_window, 1)  # SW_SHOW
                    self._agregar_log("üñ•Ô∏è Consola externa mostrada")
                else:
                    user32.ShowWindow(console_window, 0)  # SW_HIDE
                    self._agregar_log("üñ•Ô∏è Consola externa ocultada")
        except Exception as e:
            self._agregar_log(f"‚ùå Error gestionando consola: {e}")
    
    def _agregar_log(self, mensaje):
        """Agrega un mensaje al √°rea de logs."""
        from datetime import datetime
        timestamp = datetime.now().strftime("%H:%M:%S")
        formatted_msg = f"[{timestamp}] üìã {mensaje}"
        
        self.text_logs.appendPlainText(formatted_msg)
        # Auto-scroll al final
        scrollbar = self.text_logs.verticalScrollBar()
        scrollbar.setValue(scrollbar.maximum())
    
    def _organizar(self):
        """Organiza archivos nuevos."""
        try:
            self.progress_bar.setVisible(True)
            self.progress_bar.setRange(0, 0)
            
            resultados, errores = self.organizador.organizar(
                organizar_subcarpetas=self.chk_recursivo.isChecked()
            )
            
            total = sum(len(files) for cat in resultados.values() for files in cat.values())
            
            mensaje = f"‚úÖ {total} archivos organizados"
            if errores:
                mensaje += f"\n‚ö†Ô∏è {len(errores)} errores"
            
            QMessageBox.information(self, "Organizaci√≥n Completada", mensaje)
            
        except Exception as e:
            QMessageBox.critical(self, "Error", f"‚ùå Error: {e}")
        finally:
            self.progress_bar.setVisible(False)
    
    def _reorganizar(self):
        """Reorganiza todos los archivos."""
        reply = QMessageBox.question(
            self, "Reorganizar TODO",
            "¬øReorganizar TODOS los archivos?",
            QMessageBox.Yes | QMessageBox.No
        )
        
        if reply == QMessageBox.Yes:
            try:
                self.progress_bar.setVisible(True)
                self.progress_bar.setRange(0, 0)
                
                resultados, errores = self.organizador.reorganizar_completamente()
                
                total = sum(len(files) for cat in resultados.values() for files in cat.values())
                QMessageBox.information(self, "Reorganizaci√≥n", f"‚úÖ {total} archivos reorganizados")
                
            except Exception as e:
                QMessageBox.critical(self, "Error", f"‚ùå Error: {e}")
            finally:
                self.progress_bar.setVisible(False)
    
    @Slot(bool)
    def _toggle_autoarranque(self, activo):
        """Toggle autoarranque."""
        try:
            exito, mensaje = self.gestor_autoarranque.configurar_autoarranque(activo)
            if not exito:
                QMessageBox.warning(self, "Error Autoarranque", f"‚ùå {mensaje}")
                self.chk_autoarranque.setChecked(False)
        except Exception as e:
            QMessageBox.critical(self, "Error", f"‚ùå Error configurando autoarranque: {e}")
            self.chk_autoarranque.setChecked(False)
    
    def _activar_fechas(self):
        """Activar organizaci√≥n por fechas"""
        try:
            # Buscar el organizador de fechas en diferentes ubicaciones
            organizador_fechas = None
            
            if hasattr(self.organizador, 'organizador_fechas') and self.organizador.organizador_fechas:
                organizador_fechas = self.organizador.organizador_fechas
            elif hasattr(self, 'date_organizer') and self.date_organizer:
                organizador_fechas = self.date_organizer
            
            if organizador_fechas:
                patron = self.combo_patron.currentData()
                if not patron:
                    patron = self.combo_patron.currentText()
                
                resultado = organizador_fechas.activar(patron)
                
                # Actualizar estado visual
                self.lbl_estado_fechas.setText("‚úÖ Organizaci√≥n por fechas: ACTIVADA")
                self.lbl_estado_fechas.setStyleSheet("""
                    font-weight: bold; 
                    padding: 10px; 
                    color: #ffffff;
                    background-color: #4CAF50;
                    border-radius: 6px;
                    font-size: 14px;
                """)
                self.btn_activar_fechas.setEnabled(False)
                self.btn_desactivar_fechas.setEnabled(True)
                
                if hasattr(self, '_actualizar_estadisticas'):
                    self._actualizar_estadisticas()
                
                QMessageBox.information(self, "Fechas Activadas", 
                                      f"‚úÖ Organizaci√≥n por fechas activada exitosamente\n\n"
                                      f"üìã Patr√≥n configurado: {patron}\n\n"
                                      f"üìÅ Los nuevos archivos se organizar√°n en:\n"
                                      f"Downloads/Fechas/{patron}/Categor√≠a/\n\n"
                                      f"‚ÑπÔ∏è Solo afecta archivos organizados a partir de ahora")
            else:
                QMessageBox.warning(self, "Error", "‚ùå El m√≥dulo de fechas no est√° disponible\n\n"
                                  "Verifique que el m√≥dulo date_organizer est√© instalado correctamente.")
        except Exception as e:
            QMessageBox.warning(self, "Error", f"‚ùå Error al activar organizaci√≥n por fechas:\n\n{str(e)}")
            import traceback
            print(f"Error detallado en fechas: {traceback.format_exc()}")
    
    def _desactivar_fechas(self):
        """Desactivar organizaci√≥n por fechas"""
        try:
            # Buscar el organizador de fechas en diferentes ubicaciones
            organizador_fechas = None
            
            if hasattr(self.organizador, 'organizador_fechas') and self.organizador.organizador_fechas:
                organizador_fechas = self.organizador.organizador_fechas
            elif hasattr(self, 'date_organizer') and self.date_organizer:
                organizador_fechas = self.date_organizer
            
            if organizador_fechas:
                resultado = organizador_fechas.desactivar()
                
                # Actualizar estado visual
                self.lbl_estado_fechas.setText("‚ùå Organizaci√≥n por fechas: DESACTIVADA")
                self.lbl_estado_fechas.setStyleSheet("""
                    font-weight: bold; 
                    padding: 10px; 
                    color: #ffffff;
                    background-color: #f44336;
                    border-radius: 6px;
                    font-size: 14px;
                """)
                self.btn_activar_fechas.setEnabled(True)
                self.btn_desactivar_fechas.setEnabled(False)
                
                if hasattr(self, '_actualizar_estadisticas'):
                    self._actualizar_estadisticas()
                
                QMessageBox.information(self, "Fechas Desactivadas", 
                                      f"‚ùå Organizaci√≥n por fechas desactivada\n\n"
                                      f"üìÅ Los archivos volver√°n a organizarse de forma normal:\n"
                                      f"Downloads/Categor√≠a/Subcategor√≠a/\n\n"
                                      f"‚ÑπÔ∏è Los archivos ya organizados por fechas no se mueven autom√°ticamente")
            else:
                QMessageBox.warning(self, "Error", "‚ùå El m√≥dulo de fechas no est√° disponible\n\n"
                                  "Verifique que el m√≥dulo date_organizer est√© instalado correctamente.")
        except Exception as e:
            QMessageBox.warning(self, "Error", f"‚ùå Error al desactivar organizaci√≥n por fechas:\n\n{str(e)}")
            import traceback
            print(f"Error detallado en fechas: {traceback.format_exc()}")
    
    @Slot(int)
    def _actualizar_confianza(self, valor):
        """Actualiza confianza IA."""
        self.lbl_confianza.setText(f"{valor}%")
        if self.ai_categorizer:
            self.ai_categorizer.ajustar_confianza(valor / 100.0)
    
    def _entrenar_ia(self):
        """Entrena la IA."""
        if not self.ai_categorizer:
            QMessageBox.warning(self, "IA No Disponible", "IA no est√° disponible")
            return
        
        QMessageBox.information(self, "Entrenar IA", "üß† IA entrenada con historial")
        self._actualizar_patrones()
    
    def _reset_ia(self):
        """Reinicia IA."""
        if not self.ai_categorizer:
            return
        
        reply = QMessageBox.question(self, "Reset IA", "¬øReiniciar modelo?")
        if reply == QMessageBox.Yes:
            self.ai_categorizer.limpiar_modelo()
            QMessageBox.information(self, "IA", "üîÑ Modelo reiniciado")
            self._actualizar_patrones()
    
    def _actualizar_patrones(self):
        """Actualiza patrones IA."""
        if not self.ai_categorizer:
            self.text_patrones.setText("‚ùå IA no disponible")
            return
        
        try:
            stats = self.ai_categorizer.analizar_patrones_usuario()
            texto = "ü§ñ Patrones de IA:\n\n"
            
            for categoria, datos in stats.get('patrones_por_categoria', {}).items():
                texto += f"üìÇ {categoria}:\n"
                for palabra, peso in list(datos.items())[:5]:  # Top 5
                    texto += f"  ‚Ä¢ {palabra}: {peso:.2f}\n"
                texto += "\n"
            
            self.text_patrones.setText(texto)
        except:
            self.text_patrones.setText("‚ùå Error cargando patrones")
    
    def _revertir_fechas(self):
        """Revierte organizaci√≥n por fechas."""
        if not self.date_organizer:
            return
        
        reply = QMessageBox.question(self, "Revertir", "¬øRevertir organizaci√≥n por fechas?")
        if reply == QMessageBox.Yes:
            resultado = self.date_organizer.revertir_organizacion_fechas(True)
            QMessageBox.information(self, "Revertido", f"‚úÖ {resultado.get('archivos_revertidos', 0)} archivos revertidos")
    
    def _buscar_duplicados(self):
        """Busca duplicados."""
        if not self.duplicate_detector:
            QMessageBox.warning(self, "No Disponible", "Detector de duplicados no disponible")
            return
        
        try:
            self.text_duplicados.setPlainText("üîç Buscando...")
            resultado = self.duplicate_detector.escanear_duplicados()
            
            if not resultado.get('duplicados_encontrados'):
                self.text_duplicados.setPlainText("‚úÖ No hay duplicados")
                return
            
            duplicados = resultado['duplicados_encontrados']
            texto = f"üîç {len(duplicados)} grupos de duplicados:\n\n"
            
            for i, grupo in enumerate(duplicados, 1):
                archivos = grupo.get('archivos', [])
                if len(archivos) > 1:
                    texto += f"Grupo {i} ({len(archivos)} archivos):\n"
                    for archivo_info in archivos:
                        ruta = archivo_info.get('ruta', 'N/A')
                        tama√±o = archivo_info.get('tama√±o', 0)
                        texto += f"  üìÅ {ruta} ({self._formatear_bytes(tama√±o)})\n"
                    texto += "\n"
            
            self.text_duplicados.setPlainText(texto)
        except Exception as e:
            self.text_duplicados.setPlainText(f"‚ùå Error: {e}")
    
    def _eliminar_duplicados(self):
        """Elimina duplicados."""
        if not self.duplicate_detector:
            return
        
        reply = QMessageBox.question(self, "Eliminar", "¬øEliminar duplicados? Se conservar√° la copia m√°s reciente.")
        if reply == QMessageBox.Yes:
            try:
                resultado = self.duplicate_detector.eliminar_duplicados(estrategia='mas_nuevo', confirmar=True)
                QMessageBox.information(
                    self, "Duplicados",
                    f"‚úÖ {resultado.get('archivos_eliminados', 0)} duplicados eliminados\n" +
                    f"üíæ {self._formatear_bytes(resultado.get('espacio_liberado', 0))} liberados"
                )
                self._buscar_duplicados()
            except Exception as e:
                QMessageBox.critical(self, "Error", f"‚ùå Error: {e}")
    
    def _actualizar_estadisticas(self):
        """Actualiza estad√≠sticas."""
        if not self.stats_manager:
            self.text_stats.setPlainText("‚ùå Estad√≠sticas no disponibles")
            return
        
        try:
            # El m√©todo generar_reporte_completo devuelve una string, no un dict
            reporte_texto = self.stats_manager.generar_reporte_completo()
            self.text_stats.setPlainText(reporte_texto)
        except Exception as e:
            self.text_stats.setPlainText(f"‚ùå Error cargando estad√≠sticas: {e}")
    
    def _formatear_bytes(self, bytes_size: int) -> str:
        """Formatea bytes en formato legible."""
        for unit in ['B', 'KB', 'MB', 'GB', 'TB']:
            if bytes_size < 1024.0:
                return f"{bytes_size:.1f} {unit}"
            bytes_size /= 1024.0
        return f"{bytes_size:.1f} PB"

    def _seleccionar_carpeta(self):
        """Permite seleccionar una nueva carpeta para organizar."""
        nueva_carpeta = QFileDialog.getExistingDirectory(
            self, 
            "Seleccionar Carpeta para Organizar", 
            str(self.organizador.carpeta_descargas)
        )
        if nueva_carpeta:
            # Actualizar el organizador con la nueva carpeta
            self.organizador.carpeta_descargas = Path(nueva_carpeta)
            self.organizador.carpeta_config = self.organizador.carpeta_descargas / ".config"
            
            # Actualizar la interfaz
            self.lbl_carpeta_actual.setText(f"üìÅ Carpeta actual: {os.path.basename(nueva_carpeta)}")
            
            # Actualizar el header
            if hasattr(self, 'header'):
                self.header.setText(f"üçÑ DescargasOrdenadas v3.0 | üìÅ {nueva_carpeta}")
            
            # Reinitializar m√≥dulos avanzados con la nueva carpeta
            self._inicializar_modulos()
            self._actualizar_datos()
            
            # Mostrar mensaje de confirmaci√≥n
            QMessageBox.information(
                self, 
                "Carpeta Cambiada", 
                f"‚úÖ Carpeta de trabajo cambiada a:\n{nueva_carpeta}"
            )
    
    def _reset_carpeta_descargas(self):
        """Restablece la carpeta de descargas a la predeterminada."""
        from .file_organizer import OrganizadorArchivos
        # Obtener la carpeta de descargas predeterminada
        organizador_temp = OrganizadorArchivos()
        carpeta_predeterminada = organizador_temp._detectar_carpeta_descargas()
        
        # Actualizar el organizador
        self.organizador.carpeta_descargas = carpeta_predeterminada
        self.organizador.carpeta_config = self.organizador.carpeta_descargas / ".config"
        
        # Actualizar la interfaz
        self.lbl_carpeta_actual.setText(f"üìÅ Carpeta actual: {os.path.basename(carpeta_predeterminada)}")
        
        # Actualizar el header
        if hasattr(self, 'header'):
            self.header.setText(f"üçÑ DescargasOrdenadas v3.0 | üìÅ {carpeta_predeterminada}")
        
        # Reinitializar m√≥dulos avanzados
        self._inicializar_modulos()
        self._actualizar_datos()
        
        # Mostrar mensaje de confirmaci√≥n
        QMessageBox.information(
            self, 
            "Carpeta Restablecida", 
            f"‚úÖ Carpeta restablecida a la predeterminada:\n{carpeta_predeterminada}"
        )


def run_advanced_gui(directorio=None, minimizado=False):
    """Ejecuta la GUI avanzada."""
    app = QApplication.instance() or QApplication(sys.argv)
    
    window = OrganizadorAvanzado(directorio)
    
    if not minimizado:
        window.show()
    
    return app.exec() 